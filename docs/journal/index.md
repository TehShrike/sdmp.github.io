---
layout: docs
title: Journal
subtitle: Each node maintains a journal of messages it publishes.
---


## Node journal

Each node maintains an ordered list of the [resource identifiers](../resources/#resource-identifier)
of all resources it publishes, as well as all resources published by any
[connection](../resources/#identity-documents). This list is called the *node journal*,
and is unique per node.

## Journal entries

The first line of the node journal is always the key fingerprint of the node, and each following
line of the node journal is constructed by appending:

* a single newline (`\n`), then
* the hash of the previous line, which is called the *journal line number*, then
* a single `@` character, then
* the key fingerprint of the node publishing the resource, then
* a single forward slash character (`/`), then
* the resource identifier.

## Journal line number

Except for the very first line of the journal, the first hash for each entry in the
node journal is the *journal line number*.

This hash is generated by calculating the [hash](../cryptography/#hashing) of the previous
line's characters, excluding any newline characters.

E.g. the pseudo-code would be:

	hash([a-z0-9]{64}@[a-z0-9]{64}/[a-z0-9]{64})

## Writing to the journal

The node writes to its own journal under the following circumstances:

* When the node creates a new resource, it appends a new entry to
	its journal for that resource.
* Whenever the node receives a resource published by a connection, it
	appends a new entry to its own journal for that resource.

The ordering of the journal is *not* by clock time of resource publication, it is only ordered by
knowledge of the resource.

For example, if a node receives notice of a published resource several days after the publication,
the resource identifier for that resource is added to the end of the journal.

## Connection node journal status

For the purposes of synchronization, each node must maintain knowledge of each connection's
nodes. This is done by maintaining a list which contains the most recent journal line number
for every node of every connection.

The node will periodically connect to each known node and [request](../communication/) that
nodes journal entry list starting at the known most recent entry. If the returned journal
entry list contains entries not yet recorded in the requesting nodes journal, those entries
are appended to the journal.

After synchronization is done, the node would then request for unknown resources.

In this way, the node maintains knowledge of the state of all known nodes.

## Node journal example

For a user with a key fingerprint of:

	d341ba4104e7c004c2fe56d65636b945b57550081711a1d306a9f41d2b440c75

And a node with a key fingerprint of:

	7a5179eecc0fe18760ba615f92603372ae3fe302860098a019e15927551fee3b

If the node starts by publishing two resources from that user, and those resource identifiers were:

	ad700edf9094f10db2f4e56185645fd3630bbbab832d6f659dad08f0d9f43743
	9094f10db2f4e56185645fd3630bbbab832d6f659dad08f0d9f43743ad700edf

The complete node journal would look like:

	7a5179eecc0fe18760ba615f92603372ae3fe302860098a019e15927551fee3b
	1467d232075b693bd528521179679ec07a083e4f0076ecd2af61607d6b5b2b38@d341ba4104e7c004c2fe56d65636b945b57550081711a1d306a9f41d2b440c75/ad700edf9094f10db2f4e56185645fd3630bbbab832d6f659dad08f0d9f43743
	08dcde77e36f7206e31ce839449ccb07c46ab7c65328670051dc142c3f0c76d4@d341ba4104e7c004c2fe56d65636b945b57550081711a1d306a9f41d2b440c75/9094f10db2f4e56185645fd3630bbbab832d6f659dad08f0d9f43743ad700edf
